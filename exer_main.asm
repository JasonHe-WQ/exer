IOY0 EQU 3000H
AD0809 EQU IOY0 + 00H
INTR_IVADD EQU 01C8H
INTR_OCW1 EQU 0A1H
INTR_OCW2 EQU 0A0H
INTR_IM EQU 0FBH

IOY1 EQU 3040H  ;片选 I0Y1 对应的端口始地址
MY8255_A EQU IOY1 + 00H * 4 ;8255 的 A 口地址
MY8255_B EQU IOY1 + 01H * 4 ;8255 的 B 口地址
MY8255_C EQU IOY1 + 02H * 4 ;8255 的 C 口地址
MY8255_MODE EQU IOY1 + 03H * 4 ;8255 的控制寄存器地址



DATA SEGMENT
CS_BAK DW ?
IP_BAK DW ?
IM_BAK DB ?
AFTER_FILT DB 1
TEMP DB 10 DUP(0)
TABL DB 3FH,06H,5BH,4FH,66H,6DH,7DH,07H,7FH,6FH
STR1 DB  'AD0809: $'
STR2 DB  '  THRESHOLD: 200$'
STR3 DB  'WARNING WARNING  THRESHOLD: 200$'
THRESHOLD DB 200
BEFORE_FILT DB 10 DUP(0)
DATA ENDS




STACKI SEGMENT STACK
DW 256 DUP (?)
STACKI ENDS


;函数段



CODE SEGMENT
ASSUME CS:CODE, DS:DATA
START :
MOV DX ,MY8255_MODE
MOV AL ,81H
OUT DX, AL
MOV AX , DATA
MOV DS , AX


WAIT1:
MOV CX, 10 ;采样10次
MOV SI, -1





LOOPI : LEA BX, BEFORE_FILT
INC SI
MOV DX , AD0809
OUT DX , AL
CALL DALLY
MOV DX , AD0809
IN AL , DX
ADD BX, SI
MOV [BX], AL
LOOP LOOPI


CALL FILTER

MOV AL, AFTER_FILT
CMP AL, THRESHOLD
JNB INTERRUPT

PUSH CX  ;数码管显示
MOV CX, 35
SHOW:
CALL DISPLAY7SEG
LOOP SHOW
POP CX


MOV CX,5
ON_SCREEN2:
PUSH CX
MOV CX, 3
MOV BX, 0
MOV DX, OFFSET STR1
MOV AH , 9
INT 21H

ON_SCREEN:

MOV BL, CL
DEC BL
MOV DL, TEMP[BX]
ADD DL, 30H
MOV AH, 02H
INT 21H
LOOP ON_SCREEN

MOV DX, OFFSET STR2
MOV AH , 9
INT 21H
POP CX
MOV DL, 0AH
MOV AH, 02H
INT 21H
MOV DL, 0DH
MOV AH, 02H
INT 21H
LOOP ON_SCREEN2

JMP WAIT1

INTERRUPT:

MOV DX, OFFSET STR3
MOV AH , 9
INT 21H
MOV AX, 4C00H ;返回DOS界面
INT 21H
DALLY PROC NEAR ;延时程序
PUSH CX
PUSH AX
MOV CX , 4000H
D1:MOV AX , 0600H
D2:DEC AX
JNZ D2
LOOP D1
POP AX
POP CX
RET
DALLY ENDP


DALLY2 PROC NEAR ;延时程序
PUSH CX
PUSH AX
MOV CX , 4000H
D3:MOV AX , 0100H
D4:DEC AX
JNZ D4
LOOP D3
POP AX
POP CX
RET
DALLY2 ENDP

FILTER PROC NEAR ;10次取平均数
PUSH CX
PUSH AX 
PUSH BX
PUSH DX
MOV DH, 0
MOV DL, BEFORE_FILT
MOV CX, 10
MOV AX, -1

LOOP_FILTER:
LEA BX, BEFORE_FILT
INC AX
ADD BX, AX
ADD DL, [BX]
ADC DH, 0
CLC
SHR DX, 1
LOOP LOOP_FILTER
MOV AFTER_FILT,DL

POP DX
POP BX
POP AX
POP CX
RET
FILTER ENDP





DISPLAY7SEG PROC ;将存储在AFTER_FILT的滤波后数据处理,实现数据转化为十进制,并显示S
PUSH AX
PUSH BX
PUSH CX
PUSH DX
PUSH SI
PUSH DI
PUSH BP
MOV AH, 0
MOV AL, AFTER_FILT ;将8位二进制数转化为3位10进制数
MOV DL, 10
MOV CX, 3
MOV DI, -1
MOV DH, 0
DIVMOD:
INC DI
DIV DL
MOV TEMP[DI],AH
MOV AH, 0
LOOP DIVMOD


MOV AL, 0FEH ;1111 1110
MOV CX, 3
MOV DI, -1
L1:
MOV DX, MY8255_A
OUT DX, AL
CALL DISPLAY_NUMBER
ROL AL, 1
LOOP L1

POP BP
POP DI
POP SI
POP DX
POP CX
POP BX
POP AX
RET 
DISPLAY7SEG ENDP


DISPLAY_NUMBER PROC ;从TEMP列表中取10进制数,实现数字的显示,同时不破坏
PUSH AX
PUSH DX
PUSH CX
MOV CX ,1000H
SHOW_A_DIGIT:INC DI
LEA SI, TEMP
ADD SI, DI
MOV AL, [SI] ;AL为一个十进制数字
LEA BX, TABL
MOV AH, 0
ADD BX, AX
MOV AL, [BX]
MOV DX,MY8255_B
OUT DX,AL
CALL DALLY2
POP CX
POP DX
POP AX
RET
DISPLAY_NUMBER ENDP

CODE ENDS
END START


